#!/bin/bash

# Network Diagnostic Tool - Run Script
# Usage: ./run [command]
# Commands:
#   port       - Start the server on port 8080
#   build      - Build the project
#   rebuild    - Clean and rebuild
#   stop       - Stop the running server
#   restart    - Restart the server
#   status     - Show server status
#   help       - Show this help message

set -e

PROJECT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
BUILD_DIR="$PROJECT_DIR/build"
BINARY="$BUILD_DIR/network-diagnostic"
SERVER_PORT=8080
PID_FILE="/tmp/network-diagnostic.pid"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# Helper functions
log_info() {
    echo -e "${CYAN}[INFO]${NC} $1"
}

log_success() {
    echo -e "${GREEN}[✓]${NC} $1"
}

log_error() {
    echo -e "${RED}[✗]${NC} $1"
}

log_warning() {
    echo -e "${YELLOW}[!]${NC} $1"
}

# Check if binary exists
check_binary() {
    if [ ! -f "$BINARY" ]; then
        log_error "Binary not found. Building project..."
        build
    fi
}

# Build the project
build() {
    log_info "Building project..."
    cd "$PROJECT_DIR"
    make build 2>&1 | tail -5
    log_success "Build complete!"
}

# Rebuild the project
rebuild() {
    log_info "Rebuilding project..."
    cd "$PROJECT_DIR"
    make clean
    make build 2>&1 | tail -5
    log_success "Rebuild complete!"
}

# Start the server
start_server() {
    check_binary
    
    # Check if already running
    if [ -f "$PID_FILE" ]; then
        PID=$(cat "$PID_FILE")
        if kill -0 "$PID" 2>/dev/null; then
            log_warning "Server already running (PID: $PID)"
            log_info "Access at: http://localhost:$SERVER_PORT"
            return 0
        fi
    fi
    
    log_info "Starting server on port $SERVER_PORT..."
    
    # Start server in background
    "$BINARY" > /tmp/network-diagnostic.log 2>&1 &
    SERVER_PID=$!
    
    # Save PID
    echo $SERVER_PID > "$PID_FILE"
    
    # Wait a moment for server to start
    sleep 2
    
    # Check if process is still running
    if kill -0 "$SERVER_PID" 2>/dev/null; then
        log_success "Server started successfully (PID: $SERVER_PID)"
        log_info "Access at: http://localhost:$SERVER_PORT"
        log_info "Logs: tail -f /tmp/network-diagnostic.log"
    else
        log_error "Failed to start server"
        rm -f "$PID_FILE"
        cat /tmp/network-diagnostic.log
        return 1
    fi
}

# Stop the server
stop_server() {
    if [ -f "$PID_FILE" ]; then
        PID=$(cat "$PID_FILE")
        if kill -0 "$PID" 2>/dev/null; then
            log_info "Stopping server (PID: $PID)..."
            kill "$PID"
            
            # Wait for graceful shutdown
            sleep 1
            
            # Force kill if still running
            if kill -0 "$PID" 2>/dev/null; then
                kill -9 "$PID"
            fi
            
            rm -f "$PID_FILE"
            log_success "Server stopped"
        else
            log_warning "PID file exists but process not running"
            rm -f "$PID_FILE"
        fi
    else
        log_warning "Server is not running"
    fi
}

# Restart the server
restart_server() {
    log_info "Restarting server..."
    stop_server
    sleep 1
    start_server
}

# Check server status
check_status() {
    if [ -f "$PID_FILE" ]; then
        PID=$(cat "$PID_FILE")
        if kill -0 "$PID" 2>/dev/null; then
            log_success "Server is running (PID: $PID)"
            log_info "Port: $SERVER_PORT"
            log_info "URL: http://localhost:$SERVER_PORT"
            
            # Try to get connection count
            CONNECTIONS=$(netstat -tuln 2>/dev/null | grep ":$SERVER_PORT " | wc -l)
            if [ "$CONNECTIONS" -gt 0 ]; then
                log_info "Active connections: $((CONNECTIONS - 1))"
            fi
        else
            log_error "PID file exists but process not running"
            rm -f "$PID_FILE"
        fi
    else
        log_warning "Server is not running"
    fi
}

# Show help
show_help() {
    cat << EOF
${CYAN}Network Diagnostic Tool - Run Script${NC}

${YELLOW}USAGE:${NC}
    ./run [COMMAND]

${YELLOW}COMMANDS:${NC}
    port       Start the server on port 8080
    build      Build the project
    rebuild    Clean and rebuild the project
    stop       Stop the running server
    restart    Restart the server
    status     Show server status
    logs       Show server logs (live)
    help       Show this help message

${YELLOW}EXAMPLES:${NC}
    ./run port          # Start the server
    ./run rebuild       # Clean rebuild
    ./run stop          # Stop the server
    ./run restart       # Restart the server
    ./run status        # Check if server is running

${YELLOW}QUICK START:${NC}
    1. ./run rebuild    # Build the project
    2. ./run port       # Start the server
    3. Open http://localhost:8080 in your browser

${CYAN}For more info:${NC}
    Project directory: $PROJECT_DIR
    Build directory: $BUILD_DIR
    Server logs: /tmp/network-diagnostic.log

EOF
}

# Show logs
show_logs() {
    if [ -f "/tmp/network-diagnostic.log" ]; then
        log_info "Showing server logs (Ctrl+C to exit)..."
        tail -f /tmp/network-diagnostic.log
    else
        log_error "Log file not found"
    fi
}

# Main command handler
case "${1:-help}" in
    port|run)
        start_server
        ;;
    build)
        build
        ;;
    rebuild)
        rebuild
        ;;
    stop|kill)
        stop_server
        ;;
    restart)
        restart_server
        ;;
    status)
        check_status
        ;;
    logs)
        show_logs
        ;;
    help|--help|-h|"")
        show_help
        ;;
    *)
        log_error "Unknown command: $1"
        echo ""
        show_help
        exit 1
        ;;
esac
